<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cámara Mágica con Gemini (Diagnóstico)</title>
    <!-- Incluyendo Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Evita el rebote de la página al hacer scroll */
        }
        #video-source {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1; /* Indigo */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilo para scrollbar en modales y barra de botones */
        .modal-scrollbar::-webkit-scrollbar, .button-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 6px;
        }
        .modal-scrollbar::-webkit-scrollbar-track, .button-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        .modal-scrollbar::-webkit-scrollbar-thumb, .button-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        .modal-scrollbar::-webkit-scrollbar-thumb:hover, .button-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen antialiased">

    <div id="app-container" class="w-full max-w-7xl mx-auto flex-col h-full hidden">
        <!-- Encabezado -->
        <header class="text-center p-4 flex-shrink-0">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-300">Cámara Mágica</h1>
            <p class="text-gray-400 text-sm">Versión de Diagnóstico</p>
        </header>

        <!-- Contenedor Principal de la Cámara -->
        <main class="relative flex-grow min-h-0">
            <div class="relative w-full h-full bg-black rounded-xl shadow-2xl overflow-hidden border-2 border-gray-700">
                <canvas id="canvas-display" class="w-full h-full object-cover"></canvas>
            </div>
        </main>

        <!-- Controles -->
        <footer class="flex-shrink-0 w-full p-4">
           <p class="text-center text-gray-400">Las funciones de IA aparecerán aquí una vez la cámara esté activa.</p>
        </footer>
    </div>

    <!-- Pantalla de Inicio -->
    <div id="start-screen" class="w-full h-full flex flex-col items-center justify-center p-8 text-center">
        <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-300 mb-4">Prueba de Cámara</h1>
        <p class="text-gray-400 text-lg mb-8">Presiona para intentar activar la cámara.</p>
        <button id="start-camera-button" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-all duration-300 ease-in-out transform hover:scale-105 text-xl">
            Activar Cámara
        </button>
        <p id="start-error-message" class="text-red-400 mt-4 h-12"></p>
    </div>


    <video id="video-source" playsinline autoplay></video>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video-source');
            const canvas = document.getElementById('canvas-display');
            const ctx = canvas.getContext('2d');
            
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-camera-button');
            const startErrorMessage = document.getElementById('start-error-message');
            const appContainer = document.getElementById('app-container');

            let animationFrameId;
            let currentStream = null;

            async function initializeCameraSystem() {
                console.log("Botón 'Activar Cámara' presionado.");
                
                if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                    console.error("getUserMedia no es soportado por este navegador.");
                    startErrorMessage.textContent = "Error: Tu navegador no soporta el acceso a la cámara.";
                    return;
                }

                try {
                    startButton.disabled = true;
                    startButton.textContent = "Iniciando...";
                    startErrorMessage.textContent = "";
                    console.log("Solicitando acceso a la cámara con constraints básicos: { video: true }");

                    // La solicitud más simple y compatible posible
                    const constraints = { video: true };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    console.log("¡Stream de cámara obtenido exitosamente!");
                    currentStream = stream;
                    video.srcObject = stream;

                    // Esperar a que el video empiece a reproducir para obtener dimensiones
                    video.onloadedmetadata = () => {
                        console.log("Metadatos del video cargados.");
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        startScreen.style.display = 'none';
                        appContainer.style.display = 'flex';
                        
                        console.log("Iniciando bucle de dibujo (drawFrame).");
                        drawFrame();
                    };

                } catch (err) {
                    console.error("FALLO al obtener el stream de la cámara:", err.name, err.message);
                    let userMessage = "No se pudo iniciar la cámara. ";
                    if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                        userMessage += "Permiso denegado. Revisa los ajustes de tu navegador.";
                    } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                        userMessage += "No se encontró ninguna cámara.";
                    } else if (err.name === "NotReadableError" || err.name === "TrackStartError") {
                        userMessage += "La cámara ya está en uso por otra aplicación.";
                    } else {
                        userMessage += `Error: ${err.name}`;
                    }
                    startErrorMessage.textContent = userMessage;
                    startButton.disabled = false;
                    startButton.textContent = "Reintentar";
                }
            }
            
            function drawFrame() { 
                if (video.paused || video.ended) {
                    console.log("El video está pausado o ha terminado. Deteniendo el bucle.");
                    return;
                }
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height); 
                animationFrameId = requestAnimationFrame(drawFrame); 
            }
            
            startButton.addEventListener('click', initializeCameraSystem);
        });
    </script>
</body>
</html>


